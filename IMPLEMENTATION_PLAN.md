# План адаптации виджета hide_field_new_version

## Цели
1. Настраивать скрытие полей только для выбранных этапов воронки.
2. Определять текущий этап по DOM в карточке сделки (в моменте), а не по `pipeline_id` из API сделки.
3. Поддерживать динамическое переключение этапа пользователем без перезагрузки страницы.

---

## Декомпозиция на задачи

### 1) Обновить модель настроек
**Что сделать**
- Расширить `fieldConfig`:
  - `pipelines: number[]`
  - `stagesByPipeline: Record<number, number[]>` (этапы, в которых скрывается поле)
  - `managers: number[]`
  - `name: string`
- Добавить миграцию старого формата настроек (без этапов) в новый формат с безопасным дефолтом.

**Результат**
- Конфиг поддерживает гранулярность «поле → воронка → этапы».

### 2) Доработать UI настроек
**Что сделать**
- В `Setting.vue` после выбора воронки выводить мультиселект этапов:
  - либо общий список этапов выбранных воронок,
  - либо отдельные селекты по каждой воронке (предпочтительно).
- Загружать этапы через `/api/v4/leads/pipelines` (статусы внутри pipeline).
- При смене воронок очищать/валидировать этапы, которые больше не относятся к выбранным воронкам.

**Результат**
- Админ может выбрать конкретные этапы, на которых поле скрывается.

### 3) Выделить источник «текущего этапа» из DOM
**Что сделать**
- Добавить утилиту `getCurrentLeadContextFromDOM()`:
  - читает `pipelineId` и `statusId` из DOM (селектор текущего этапа).
  - возвращает `null`, если карточка еще не отрисована.
- Не использовать API сделки для вычисления текущего этапа в рантайме (для скрытия).

**Результат**
- Логика опирается на фактическое состояние интерфейса в текущий момент.

### 4) Переписать правила применения скрытия
**Что сделать**
- В `customizeFields`/`customize` проверять:
  - менеджер входит в `setting.managers`;
  - текущая воронка входит в `setting.pipelines`;
  - текущий `statusId` входит в `stagesByPipeline[currentPipelineId]`.
- Добавить два режима применения:
  - `hideMatchedFields(context)` — скрыть поля по совпавшим правилам;
  - `resetAllManagedFields()` — вернуть видимость перед повторным применением.

**Результат**
- При смене этапа поля корректно «пересчитываются», без залипания скрытия.

### 5) Реакция на динамическую смену этапа
**Что сделать**
- Подписаться на изменения DOM именно в зоне селектора этапа.
- Дебаунс/троттл пересчета (например, 100–200 мс), чтобы не дергать логику на каждую микро-мутацию.
- На событие смены этапа запускать:
  1) `resetAllManagedFields()`
  2) чтение нового `context` из DOM
  3) `hideMatchedFields(context)`

**Результат**
- Юзер меняет этап вручную — набор скрытых полей меняется сразу.

### 6) Надежность и fallback
**Что сделать**
- Если DOM-этап не найден:
  - не скрывать ничего агрессивно,
  - повторить попытку через короткий таймер/следующую мутацию.
- Логирование в `console.debug` под feature-flag (для диагностики на проде).

**Результат**
- Нет случайного скрытия на «пустом» контексте.

### 7) Тест-кейсы и приемка
**Минимум для проверки**
- Поле скрывается только на выбранных этапах выбранной воронки.
- На невыбранных этапах это же поле снова видно.
- При ручной смене этапа без перезагрузки поведение меняется мгновенно.
- Для менеджеров вне списка поле не скрывается.
- Старые настройки (без этапов) не ломают виджет.

---

## Порядок реализации (рекомендуемый)
1. Модель данных + миграция конфига.
2. UI этапов в настройках.
3. DOM-ридер текущего этапа.
4. Новый движок применения/сброса скрытия.
5. Подписка на смену этапа + дебаунс.
6. Ручная регрессия по тест-кейсам.

---

## Технические риски и как закрыть
- **Риск:** селекторы amoCRM могут меняться.
  - **Мера:** обернуть в отдельный модуль с 2–3 fallback-селекторами и graceful degradation.
- **Риск:** мерцание полей при частых мутациях.
  - **Мера:** дебаунс + идемпотентный apply (не выполнять лишние стили, если состояние не изменилось).
- **Риск:** неоднозначность в старых настройках без этапов.
  - **Мера:** миграционное правило (например, «все этапы выбранных воронок») и явный маркер версии конфига.

---

## Definition of Done
- В настройках можно выбрать этапы для каждого правила скрытия.
- В рантайме виджет берет текущий этап из DOM и корректно реагирует на его изменение.
- Поля скрываются/показываются без перезагрузки и без накопления визуальных артефактов.
- Старые конфиги продолжают работать после миграции.
